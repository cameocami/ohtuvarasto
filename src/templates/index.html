<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Varastosovellus</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>Varastosovellus</h1>
        <button id="add-varasto-btn" class="add-btn" title="Luo uusi varasto">+</button>
    </header>

    <main>
        <div id="varastot-container" class="varastot-container">
            <!-- Varasto elements will be added here dynamically -->
        </div>
    </main>

    <!-- Create Varasto Pop-up -->
    <div id="create-popup" class="popup-overlay hidden">
        <div class="popup">
            <button class="close-btn" id="close-create-popup">&times;</button>
            <h2>Luo uusi varasto</h2>
            <form id="create-varasto-form">
                <div class="form-group">
                    <label for="tilavuus">Tilavuus:</label>
                    <input type="number" id="tilavuus" name="tilavuus" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label for="alku_saldo">Alkusaldo:</label>
                    <input type="number" id="alku_saldo" name="alku_saldo" step="0.1" min="0" value="0">
                </div>
                <button type="submit" class="submit-btn">Luo</button>
            </form>
        </div>
    </div>

    <!-- Edit Varasto Pop-up -->
    <div id="edit-popup" class="popup-overlay hidden">
        <div class="popup">
            <button class="close-btn" id="close-edit-popup">&times;</button>
            <h2>Muokkaa varastoa</h2>
            <form id="edit-varasto-form">
                <input type="hidden" id="edit-varasto-id">
                <div class="form-group">
                    <label for="edit-tilavuus">Tilavuus:</label>
                    <input type="number" id="edit-tilavuus" name="tilavuus" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label for="edit-alku_saldo">Alkusaldo:</label>
                    <input type="number" id="edit-alku_saldo" name="alku_saldo" step="0.1" min="0" value="0">
                </div>
                <button type="submit" class="submit-btn">Tallenna</button>
                <button type="button" id="delete-varasto-btn" class="delete-btn">Poista</button>
            </form>
        </div>
    </div>

    <script>
        // State
        let varastot = [];
        let activeBubble = null;

        // Load varastot on page load
        document.addEventListener('DOMContentLoaded', loadVarastot);

        // Open create popup
        document.getElementById('add-varasto-btn').addEventListener('click', function() {
            document.getElementById('create-popup').classList.remove('hidden');
        });

        // Close create popup
        document.getElementById('close-create-popup').addEventListener('click', function() {
            document.getElementById('create-popup').classList.add('hidden');
        });

        // Close edit popup
        document.getElementById('close-edit-popup').addEventListener('click', function() {
            document.getElementById('edit-popup').classList.add('hidden');
        });

        // Create varasto form submit
        document.getElementById('create-varasto-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const tilavuus = document.getElementById('tilavuus').value;
            const alku_saldo = document.getElementById('alku_saldo').value;

            fetch('/api/varastot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tilavuus: parseFloat(tilavuus),
                    alku_saldo: parseFloat(alku_saldo)
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('create-popup').classList.add('hidden');
                document.getElementById('create-varasto-form').reset();
                loadVarastot();
            });
        });

        // Edit varasto form submit
        document.getElementById('edit-varasto-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const varastoId = document.getElementById('edit-varasto-id').value;
            const tilavuus = document.getElementById('edit-tilavuus').value;
            const alku_saldo = document.getElementById('edit-alku_saldo').value;

            fetch(`/api/varastot/${varastoId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tilavuus: parseFloat(tilavuus),
                    alku_saldo: parseFloat(alku_saldo)
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('edit-popup').classList.add('hidden');
                loadVarastot();
            });
        });

        // Delete varasto
        document.getElementById('delete-varasto-btn').addEventListener('click', function() {
            const varastoId = document.getElementById('edit-varasto-id').value;
            
            fetch(`/api/varastot/${varastoId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('edit-popup').classList.add('hidden');
                loadVarastot();
            });
        });

        function loadVarastot() {
            fetch('/api/varastot')
            .then(response => response.json())
            .then(data => {
                varastot = data;
                renderVarastot();
            });
        }

        function renderVarastot() {
            const container = document.getElementById('varastot-container');
            container.innerHTML = '';

            varastot.forEach(varasto => {
                const element = createVarastoElement(varasto);
                container.appendChild(element);
            });
        }

        function createVarastoElement(varasto) {
            const wrapper = document.createElement('div');
            wrapper.className = 'varasto-wrapper';
            wrapper.id = 'varasto-wrapper-' + varasto.id;

            const element = document.createElement('div');
            element.className = 'varasto-element';
            element.id = 'varasto-' + varasto.id;

            const fillPercentage = (varasto.saldo / varasto.tilavuus) * 100;
            
            element.innerHTML = `
                <div class="varasto-fill" style="height: ${fillPercentage}%"></div>
                <div class="varasto-info">
                    <span class="varasto-space">Tilaa: <span id="space-${varasto.id}">${varasto.paljonko_mahtuu.toFixed(1)}</span></span>
                </div>
            `;

            element.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleBubble(varasto.id, wrapper);
            });

            // Double-click to edit
            element.addEventListener('dblclick', function(e) {
                e.stopPropagation();
                openEditPopup(varasto);
            });

            wrapper.appendChild(element);
            return wrapper;
        }

        function toggleBubble(varastoId, wrapper) {
            // Close any existing bubble
            if (activeBubble) {
                activeBubble.remove();
                activeBubble = null;
            }

            // Create new bubble
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.innerHTML = `
                <button class="bubble-close">&times;</button>
                <div class="bubble-content">
                    <div class="bubble-group">
                        <input type="number" id="lisaa-maara-${varastoId}" step="0.1" min="0" placeholder="Määrä">
                        <button class="bubble-btn lisaa-btn" data-id="${varastoId}">Lisää</button>
                    </div>
                    <div class="bubble-group">
                        <input type="number" id="ota-maara-${varastoId}" step="0.1" min="0" placeholder="Määrä">
                        <button class="bubble-btn ota-btn" data-id="${varastoId}">Ota</button>
                    </div>
                </div>
                <div class="bubble-arrow"></div>
            `;

            wrapper.appendChild(bubble);
            activeBubble = bubble;

            // Close button
            bubble.querySelector('.bubble-close').addEventListener('click', function(e) {
                e.stopPropagation();
                bubble.remove();
                activeBubble = null;
            });

            // Lisää button
            bubble.querySelector('.lisaa-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                const maara = document.getElementById('lisaa-maara-' + varastoId).value;
                if (maara) {
                    lisaaVarastoon(varastoId, parseFloat(maara), wrapper);
                }
            });

            // Ota button
            bubble.querySelector('.ota-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                const maara = document.getElementById('ota-maara-' + varastoId).value;
                if (maara) {
                    otaVarastosta(varastoId, parseFloat(maara), wrapper);
                }
            });
        }

        function lisaaVarastoon(varastoId, maara, wrapper) {
            fetch(`/api/varastot/${varastoId}/lisaa`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ maara: maara })
            })
            .then(response => response.json())
            .then(data => {
                updateVarastoDisplay(varastoId, data);
                showFloatingNumber(wrapper, `+${data.added.toFixed(1)}`, 'green');
            });
        }

        function otaVarastosta(varastoId, maara, wrapper) {
            fetch(`/api/varastot/${varastoId}/ota`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ maara: maara })
            })
            .then(response => response.json())
            .then(data => {
                updateVarastoDisplay(varastoId, data);
                showFloatingNumber(wrapper, `-${data.taken.toFixed(1)}`, 'red');
            });
        }

        function updateVarastoDisplay(varastoId, data) {
            const spaceElement = document.getElementById('space-' + varastoId);
            if (spaceElement) {
                spaceElement.textContent = data.paljonko_mahtuu.toFixed(1);
            }

            const fillElement = document.querySelector('#varasto-' + varastoId + ' .varasto-fill');
            if (fillElement) {
                const fillPercentage = (data.saldo / data.tilavuus) * 100;
                fillElement.style.height = fillPercentage + '%';
            }

            // Update local state
            const varasto = varastot.find(v => v.id === varastoId);
            if (varasto) {
                varasto.saldo = data.saldo;
                varasto.paljonko_mahtuu = data.paljonko_mahtuu;
            }
        }

        function showFloatingNumber(wrapper, text, color) {
            const floatingNum = document.createElement('div');
            floatingNum.className = 'floating-number';
            floatingNum.textContent = text;
            floatingNum.style.color = color === 'green' ? '#2e8b57' : '#dc143c';
            
            wrapper.appendChild(floatingNum);

            // Trigger animation
            setTimeout(() => {
                floatingNum.classList.add('animate');
            }, 10);

            // Remove after animation
            setTimeout(() => {
                floatingNum.remove();
            }, 2000);
        }

        function openEditPopup(varasto) {
            document.getElementById('edit-varasto-id').value = varasto.id;
            document.getElementById('edit-tilavuus').value = varasto.tilavuus;
            document.getElementById('edit-alku_saldo').value = varasto.saldo;
            document.getElementById('edit-popup').classList.remove('hidden');
        }

        // Close bubble when clicking outside
        document.addEventListener('click', function(e) {
            if (activeBubble && !activeBubble.contains(e.target)) {
                activeBubble.remove();
                activeBubble = null;
            }
        });
    </script>
</body>
</html>
